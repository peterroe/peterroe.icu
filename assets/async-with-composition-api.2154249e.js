import{_ as o}from"./Post.915cc3e2.js";import{j as c,k as p,g as l,o as u,a as n,i as s}from"./vendor.2adeb70a.js";import"./app.c8fe7c31.js";const i=n("div",{class:"prose m-auto"},[n("p",null,"There is a major caveat when working with asynchronous functions in Vue Composition API, that I believe many of you have ever come across. I have acknowledged it for a while from somewhere, but every time I want to have a detailed reference and share to others, I can\u2019t find it\u2019s documented anywhere. So, I am thinking about writing one, with a detailed explanation while sorting out the possible solutions for you."),n("ul",null,[n("li",null,[n("a",{href:"#the-problem"},"The Problem")]),n("li",null,[n("a",{href:"#the-mechanism"},"The Mechanism")]),n("li",null,[n("a",{href:"#the-limitation"},"The Limitation")]),n("li",null,[n("a",{href:"#the-solutions"},"The Solutions")])]),n("h2",{id:"the-problem",tabindex:"-1"},[s("The Problem "),n("a",{class:"header-anchor",href:"#the-problem","aria-hidden":"true"},"#")]),n("p",null,[s("When using asynchronous "),n("code",null,"setup()"),s(", "),n("strong",null,[s("you have to use effects and lifecycle hooks before the first "),n("code",null,"await"),s(" statement.")]),s(" ("),n("a",{href:"https://github.com/vuejs/rfcs/discussions/234",target:"_blank",rel:"noopener"},"details"),s(")")]),n("p",null,"For example:"),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" ref"),n("span",{class:"token punctuation"},","),s(" watch"),n("span",{class:"token punctuation"},","),s(" onMounted"),n("span",{class:"token punctuation"},","),s(" onUnmounted "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},"'vue'"),s(`

`),n("span",{class:"token keyword"},"export"),s(),n("span",{class:"token keyword"},"default"),s(),n("span",{class:"token function"},"defineAsyncComponent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"const"),s(" counter "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ref"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token function"},"watch"),n("span",{class:"token punctuation"},"("),s("counter"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),s("counter"),n("span",{class:"token punctuation"},"."),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"// OK!"),s(`
    `),n("span",{class:"token function"},"onMounted"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Mounted'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"// the await statement"),s(`
    `),n("span",{class:"token keyword"},"await"),s(),n("span",{class:"token function"},"someAsyncFunction"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// <-----------"),s(`

    `),n("span",{class:"token comment"},"// does NOT work!"),s(`
    `),n("span",{class:"token function"},"onUnmounted"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Unmounted'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"// still works, but does not auto-dispose "),s(`
    `),n("span",{class:"token comment"},"// after the component is destroyed (memory leak!)"),s(`
    `),n("span",{class:"token function"},"watch"),n("span",{class:"token punctuation"},"("),s("counter"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),s("counter"),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("p",null,[s("After the "),n("code",null,"await"),s(" statement,")]),n("p",null,[s("the following functions will be "),n("strong",null,"limited"),s(" (no auto-dispose):")]),n("ul",null,[n("li",null,[n("code",null,"watch"),s(" / "),n("code",null,"watchEffect")]),n("li",null,[n("code",null,"computed")]),n("li",null,[n("code",null,"effect")])]),n("p",null,[s("the following functions will "),n("strong",null,"not work"),s(":")]),n("ul",null,[n("li",null,[n("code",null,"onMounted"),s(" / "),n("code",null,"onUnmounted"),s(" / "),n("code",null,"onXXX")]),n("li",null,[n("code",null,"provide"),s(" / "),n("code",null,"inject")]),n("li",null,[n("code",null,"getCurrentInstance")]),n("li",null,"\u2026")]),n("h2",{id:"the-mechanism",tabindex:"-1"},[s("The Mechanism "),n("a",{class:"header-anchor",href:"#the-mechanism","aria-hidden":"true"},"#")]),n("p",null,[s("Let\u2019s take the "),n("code",null,"onMounted"),s(" API as an example. As we know, "),n("code",null,"onMounted"),s(" is a hook that registers a listener when the current component gets mounted. Notice that "),n("code",null,"onMounted"),s(" (along with other composition APIs) are "),n("strong",null,"global"),s(', for what I mean "global" is that it can be imported and called anywhere - there is '),n("strong",null,"no local context"),s(" bound to it.")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token comment"},"// local: `onMounted` is a method of `component` that bound to it"),s(`
component`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"onMounted"),n("span",{class:"token punctuation"},"("),n("span",{class:"token comment"},"/* ... */"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"// global: `onMounted` can be called without context"),s(`
`),n("span",{class:"token function"},"onMounted"),n("span",{class:"token punctuation"},"("),n("span",{class:"token comment"},"/* ... */"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("p",null,[s("So, how does "),n("code",null,"onMounted"),s(" know what component is being mounted?")]),n("p",null,"Vue takes an interesting approach to solve this. It uses an internal variable to record the current component instance. There is a simplified code:"),n("p",null,"When Vue mounts a component, it stores the instance in a global variable. When hooks been called inside the setup function, it will use the global variable to get the current component instance."),n("pre",{class:"language-js"},[n("code",{class:"language-js"},[n("span",{class:"token keyword"},"let"),s(" currentInstance "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"null"),s(`

`),n("span",{class:"token comment"},"// (pseudo code)"),s(`
`),n("span",{class:"token keyword"},"export"),s(),n("span",{class:"token keyword"},"function"),s(),n("span",{class:"token function"},"mountComponent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token parameter"},"component"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"const"),s(" instance "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"createComponent"),n("span",{class:"token punctuation"},"("),s("component"),n("span",{class:"token punctuation"},")"),s(`

  `),n("span",{class:"token comment"},"// hold the previous instance"),s(`
  `),n("span",{class:"token keyword"},"const"),s(" prev "),n("span",{class:"token operator"},"="),s(` currentInstance

  `),n("span",{class:"token comment"},"// set the instance to global"),s(`
  currentInstance `),n("span",{class:"token operator"},"="),s(` instance

  `),n("span",{class:"token comment"},"// hooks called inside the `setup()` will have"),s(`
  `),n("span",{class:"token comment"},"// the `currentInstance` as the context"),s(`
  component`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(` 

  `),n("span",{class:"token comment"},"// restore the previous instance"),s(`
  currentInstance `),n("span",{class:"token operator"},"="),s(` prev 
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("p",null,[s("A simplified "),n("code",null,"onMounted"),s(" implementation would be like:")]),n("pre",{class:"language-js"},[n("code",{class:"language-js"},[n("span",{class:"token comment"},"// (pseudo code)"),s(`
`),n("span",{class:"token keyword"},"export"),s(),n("span",{class:"token keyword"},"function"),s(),n("span",{class:"token function"},"onMounted"),n("span",{class:"token punctuation"},"("),n("span",{class:"token parameter"},"fn"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("currentInstance"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"warn"),n("span",{class:"token punctuation"},"("),n("span",{class:"token template-string"},[n("span",{class:"token template-punctuation string"},"`"),n("span",{class:"token string"},`"onMounted" can't be called outside of component setup()`),n("span",{class:"token template-punctuation string"},"`")]),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"// bound listener to the current instance"),s(`
  currentInstance`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"onMounted"),n("span",{class:"token punctuation"},"("),s("fn"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("p",null,[s("With this approach, as long as the "),n("code",null,"onMounted"),s(" is called inside the component "),n("code",null,"setup()"),s(", it will be able to get the instance of the current component.")]),n("h2",{id:"the-limitation",tabindex:"-1"},[s("The Limitation "),n("a",{class:"header-anchor",href:"#the-limitation","aria-hidden":"true"},"#")]),n("p",null,"So far so good, but what\u2019s wrong with asynchronous functions?"),n("p",null,[s("The implementation would work based on the fact that JavaScript is "),n("strong",null,"single-threaded"),s(". Single thread makes sure the following statements will be executed right next to each other, which in other words, there is no one could accidentally modify the "),n("code",null,"currentInstance"),s(" at the same time (a.k.a. it\u2019s "),n("a",{href:"https://stackoverflow.com/questions/52196678/what-are-atomic-operations-for-newbies",target:"_blank",rel:"noopener"},"atomic"),s(").")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[s("currentInstance "),n("span",{class:"token operator"},"="),s(` instance
component`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(` 
currentInstance `),n("span",{class:"token operator"},"="),s(` prev 
`)])]),n("p",null,[s("The situation changes when the "),n("code",null,"setup()"),s(" is asynchronous. Whenever you "),n("code",null,"await"),s(" a promise, you can think the engine paused the works here and went to do another task. If we "),n("code",null,"await"),s(" the function, during the time period, multiple components creation will change the global variable unpredictably and end up with a mess.")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[s("currentInstance "),n("span",{class:"token operator"},"="),s(` instance
`),n("span",{class:"token keyword"},"await"),s(" component"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// atomic lost"),s(`
currentInstance `),n("span",{class:"token operator"},"="),s(` prev 
`)])]),n("p",null,[s("If we don\u2019t use "),n("code",null,"await"),s(" to check the instance, calling the "),n("code",null,"setup()"),s(" function will make it finish the tasks before the first "),n("code",null,"await"),s(" statement, and the rest will be executed whenever the "),n("code",null,"await"),s(" statement is resolved.")]),n("div",{class:"grid grid-cols-2 gap-2 lt-sm:grid-cols-1"},[n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"function"),s(),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token keyword"},"await"),s(),n("span",{class:"token function"},"someAsyncFunction"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token comment"},"// output:"),s(`
`),n("span",{class:"token number"},"3"),s(`
`),n("span",{class:"token number"},"1"),s(`
`),n("span",{class:"token number"},"4"),s(`
`),n("span",{class:"token punctuation"},"("),s("awaiting"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token number"},"2"),s(`
`)])])]),n("p",null,"This means, there is no way for Vue to know when will the asynchronous part been called from the outside, so there is also no way to bound the instance to the context."),n("h2",{id:"the-solutions",tabindex:"-1"},[s("The Solutions "),n("a",{class:"header-anchor",href:"#the-solutions","aria-hidden":"true"},"#")]),n("p",null,"This is actually a limitation of JavaScript itself, unless we have some new proposal to open the gate on the language level, we have to live with it."),n("p",null,"But to work around it, I have collected a few solutions for you to choose from based on your needs."),n("h3",{id:"remember-the-caveat-and-avoid-it",tabindex:"-1"},[s("Remember the Caveat and Avoid It "),n("a",{class:"header-anchor",href:"#remember-the-caveat-and-avoid-it","aria-hidden":"true"},"#")]),n("p",null,[s('This is, of course, an obvious "solution". You can try to move your effect and hooks before the first '),n("code",null,"await"),s(" statement and carefully remember not to have them after that again.")]),n("p",null,[s("Luckily, if you are using ESLint, you can have the "),n("a",{href:"https://eslint.vuejs.org/rules/no-watch-after-await.html",target:"_blank",rel:"noopener"},[n("code",null,"vue/no-watch-after-await")]),s(" and "),n("a",{href:"https://eslint.vuejs.org/rules/no-lifecycle-after-await.html",target:"_blank",rel:"noopener"},[n("code",null,"vue/no-lifecycle-after-await")]),s(" rules from "),n("a",{href:"https://eslint.vuejs.org/",target:"_blank",rel:"noopener"},[n("code",null,"eslint-plugin-vue")]),s(" enabled so it could warn you whenever you made some mistakes (they are enabled by default within the plugin presets).")]),n("h3",{id:"wrap-the-async-function-as-reactive-sync",tabindex:"-1"},[s('Wrap the Async Function as "Reactive Sync" '),n("a",{class:"header-anchor",href:"#wrap-the-async-function-as-reactive-sync","aria-hidden":"true"},"#")]),n("p",null,[s("In some situations, your logic might be relying on the data that fetched asynchronously. In this way, you could consider using the "),n("a",{href:"/posts/composable-vue-vueday-2021#async-to-sync"},"trick I have shared on VueDay 2021"),s(" to "),n("strong",null,"turn your async function into a sync reactive state"),s(".")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"const"),s(" data "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(),n("span",{class:"token function"},"fetch"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'https://api.github.com/'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"then"),n("span",{class:"token punctuation"},"("),s("r "),n("span",{class:"token operator"},"=>"),s(" r"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"json"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"const"),s(" user "),n("span",{class:"token operator"},"="),s(" data"),n("span",{class:"token punctuation"},"."),s(`user
`)])]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"const"),s(" data "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ref"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token function"},"fetch"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'https://api.github.com/'"),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"then"),n("span",{class:"token punctuation"},"("),s("r "),n("span",{class:"token operator"},"=>"),s(" r"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"json"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"then"),n("span",{class:"token punctuation"},"("),s("res "),n("span",{class:"token operator"},"=>"),s(" data"),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"="),s(" res"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"const"),s(" user "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"computed"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" data"),n("span",{class:"token operator"},"?."),s("user"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("p",null,'This approach make the "connections" between your logic to resolve first, and then reactive updates when the asynchronous function get resolved and filled with data.'),n("p",null,[s("There is also some more general utilities for it from "),n("a",{href:"https://vueuse.org/",target:"_blank",rel:"noopener"},"VueUse"),s(":")]),n("h4",{id:"useasyncstate",tabindex:"-1"},[n("a",{href:"https://vueuse.org/useAsyncState",target:"_blank",rel:"noopener"},[n("code",null,"useAsyncState")]),s(),n("a",{class:"header-anchor",href:"#useasyncstate","aria-hidden":"true"},"#")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" useAsyncState "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},"'@vueuse/core'"),s(`

`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token punctuation"},"{"),s(" state"),n("span",{class:"token punctuation"},","),s(" ready "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"useAsyncState"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token punctuation"},"{"),s(" data "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" axios"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'https://api.github.com/'"),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"{"),s(" data "),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"const"),s(" user "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"computed"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" state"),n("span",{class:"token operator"},"?."),s("user"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h4",{id:"usefetch",tabindex:"-1"},[n("a",{href:"https://vueuse.org/useFetch",target:"_blank",rel:"noopener"},[n("code",null,"useFetch")]),s(),n("a",{class:"header-anchor",href:"#usefetch","aria-hidden":"true"},"#")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" useFetch "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},"'@vueuse/core'"),s(`

`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token punctuation"},"{"),s(" data"),n("span",{class:"token punctuation"},","),s(" isFetching"),n("span",{class:"token punctuation"},","),s(" error "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"useFetch"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'https://api.github.com/'"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"const"),s(" user "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"computed"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" data"),n("span",{class:"token operator"},"?."),s("user"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h3",{id:"explicitly-bound-the-instance",tabindex:"-1"},[s("Explicitly Bound the Instance "),n("a",{class:"header-anchor",href:"#explicitly-bound-the-instance","aria-hidden":"true"},"#")]),n("p",null,"Lifecycle hooks actually accept a second argument for setting the instance explicitly."),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"export"),s(),n("span",{class:"token keyword"},"default"),s(),n("span",{class:"token function"},"defineAsyncComponent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// get and hold the instance before `await`"),s(`
    `),n("span",{class:"token keyword"},"const"),s(" instance "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getCurrentInstance"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"await"),s(),n("span",{class:"token function"},"someAsyncFunction"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// <-----------"),s(`

    `),n("span",{class:"token function"},"onUnmounted"),n("span",{class:"token punctuation"},"("),s(`
      `),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token builtin"},"console"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"log"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Unmounted'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      instance `),n("span",{class:"token comment"},"// <--- pass the instance to it"),s(`
    `),n("span",{class:"token punctuation"},")"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("p",null,[s("However, the downside is that this solution "),n("strong",null,"does not work"),s(" with "),n("code",null,"watch"),s(" / "),n("code",null,"watchEffect"),s(" / "),n("code",null,"computed"),s(" / "),n("code",null,"provide"),s(" / "),n("code",null,"inject"),s(" as they does not accept the instance argument.")]),n("p",null,[s("To get the effects work, you could use the "),n("a",{href:"https://github.com/vuejs/rfcs/blob/master/active-rfcs/0041-reactivity-effect-scope.md",target:"_blank",rel:"noopener"},[n("code",null,"effectScope"),s(" API")]),s(" in the upcoming Vue 3.2.")]),n("pre",{class:"language-ts"},[n("code",{class:"language-ts"},[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" effectScope "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},"'vue'"),s(`

`),n("span",{class:"token keyword"},"export"),s(),n("span",{class:"token keyword"},"default"),s(),n("span",{class:"token function"},"defineAsyncComponent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// create the scope before `await`, so it will be bond to the instance"),s(`
    `),n("span",{class:"token keyword"},"const"),s(" scope "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"effectScope"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"const"),s(" data "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(),n("span",{class:"token function"},"someAsyncFunction"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// <-----------"),s(`

    scope`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token comment"},"/* Use `computed`, `watch`, etc. ... */"),s(`
    `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"// the lifecycle hooks will not be available here,"),s(`
    `),n("span",{class:"token comment"},"// you will need to combine it with the previous snippet"),s(`
    `),n("span",{class:"token comment"},"// to have both lifecycle hooks and effects works."),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h3",{id:"compile-time-magic",tabindex:"-1"},[s("Compile-time Magic! "),n("a",{class:"header-anchor",href:"#compile-time-magic","aria-hidden":"true"},"#")]),n("p",null,[s("In the recent "),n("a",{href:"https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md",target:"_blank",rel:"noopener"},[n("code",null,"<script setup>"),s(" proposal")]),s(" update, a new "),n("a",{href:"https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md#top-level-await",target:"_blank",rel:"noopener"},"compile-time magic"),s(" is introduced.")]),n("p",null,[s("The way it works is to inject a script after each "),n("code",null,"await"),s(" statement for restoring the current instance state.")]),n("pre",{class:"language-html"},[n("code",{class:"language-html"},[n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("script")]),s(),n("span",{class:"token attr-name"},"setup"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token script"},[n("span",{class:"token language-javascript"},[s(`
`),n("span",{class:"token keyword"},"const"),s(" post "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(),n("span",{class:"token function"},"fetch"),n("span",{class:"token punctuation"},"("),n("span",{class:"token template-string"},[n("span",{class:"token template-punctuation string"},"`"),n("span",{class:"token string"},"/api/post/1"),n("span",{class:"token template-punctuation string"},"`")]),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"then"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token parameter"},"r"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" r"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"json"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("script")]),n("span",{class:"token punctuation"},">")]),s(`
`)])]),n("pre",{class:"language-js"},[n("code",{class:"language-js"},[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" withAsyncContext "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},"'vue'"),s(`

`),n("span",{class:"token keyword"},"export"),s(),n("span",{class:"token keyword"},"default"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token function"},"setup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"let"),s(" __temp"),n("span",{class:"token punctuation"},","),s(` __restore

    `),n("span",{class:"token keyword"},"const"),s(" post "),n("span",{class:"token operator"},"="),s(`
      `),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),s("__temp"),n("span",{class:"token punctuation"},","),s(" __restore"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"withAsyncContext"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(`
        `),n("span",{class:"token function"},"fetch"),n("span",{class:"token punctuation"},"("),n("span",{class:"token template-string"},[n("span",{class:"token template-punctuation string"},"`"),n("span",{class:"token string"},"/api/post/1"),n("span",{class:"token template-punctuation string"},"`")]),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"then"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token parameter"},"r"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" r"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"json"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      `),n("span",{class:"token punctuation"},"("),s("__temp "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" __temp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      `),n("span",{class:"token function"},"__restore"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      __temp`),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"// current instance context preserved"),s(`
    `),n("span",{class:"token comment"},"// e.g. onMounted() will still work."),s(`

    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"{"),s(" post "),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("p",null,[s("With it, the async functions will "),n("strong",null,"just work"),s(" when using with "),n("code",null,"<script setup>"),s(". The only shame is it does not work outside of "),n("code",null,"<script setup>"),s(".")])],-1),w={setup(r,{expose:a}){const t={title:"Async with Composition API",description:"Notes about the caveat when using async functions in Vue Composition API.",date:"2021-07-16T08:00:00.000Z",lang:"en",duration:"17min",meta:[{property:"og:title",content:"Async with Composition API"},{property:"og:description",content:"Notes about the caveat when using async functions in Vue Composition API."},{name:"description",content:"Notes about the caveat when using async functions in Vue Composition API."}]};return a({frontmatter:t}),c({title:"Async with Composition API",meta:[{property:"og:title",content:"Async with Composition API"},{property:"og:description",content:"Notes about the caveat when using async functions in Vue Composition API."},{name:"description",content:"Notes about the caveat when using async functions in Vue Composition API."}]}),(d,h)=>{const e=o;return u(),p(e,{frontmatter:t},{default:l(()=>[i]),_:1})}}};export{w as default};
